define(function(){return{init:function(t,a,r){var e,i,s,h,n,y,o;for(this.bindEvents(),this._datas=r,n=[],this._darray=$.map(r,function(t){return[t]}),e=document.getElementById("c"),i=e.getContext("2d"),this.ctx=i,this.mapW=t,this.mapH=a,this.mapArray=[],y=0,o=0,this.mapArray=this.creatMap(),this.mapArray=this.random(this.mapArray),s=0;s<this.mapH;){for(h=0;h<this.mapW;)0===this.mapArray[s][h]?(this.mapArray[s][h]={},this.mapArray[s][h].type=0,this.mapArray[s][h].nu=0):this.drawImg(this.mapArray[s][h],y,o,s,h),y=y<100*(this.mapW-1)?y+100:0,++h;o=o<100*(this.mapH-1)?o+100:0,++s}},randomPic:function(t){var a;for(a=Math.floor(8*Math.random())-1;!this._darray[t][a];)a=Math.floor(8*Math.random())-1;return a},creatMap:function(){var t,a,r,e;for(r=1,e=[],t=0;t<this.mapH;){for(e.push([]),a=0;a<this.mapW;)0===a||a===this.mapW-1||0===t||t===this.mapH-1?(e[t].push(0),++a):(e[t].push(r),++a,e[t].push(r),++r,++a,r>10&&(r=1));++t}return e},drawMap:function(){},random:function(t){var a,r,e,i,s,h,n,y,o;for(r=1,a=this.mapH-2;a>=r;){for(e=1,s=this.mapW-2;s>=e;)y=parseInt(100*Math.random()%a+1),h=parseInt(100*Math.random()%s+1),o=parseInt(100*Math.random()%a+1),n=parseInt(100*Math.random()%s+1),i=t[y][h],t[y][h]=t[o][n],t[o][n]=i,++e;++r}return t},drawImg:function(t,a,r,e,i){var s,h,n,y;s=this.ctx,y=100,n=100,t-=1,t>=0&&(e&&i&&"classic"!==window.mode?(h=this.randomPic(t),this.mapArray[e][i]={},this.mapArray[e][i].type=t+1,this.mapArray[e][i].nu=h):(h=1,this.mapArray[e][i]={},this.mapArray[e][i].type=t+1,this.mapArray[e][i].nu=h),s.fillStyle="rgba(255, 255, 255, 0.3)",s.fillRect(a,r,100,100),s.drawImage(document.getElementById(this._darray[t][h]),a,r,98,98),s.lineWidth=1,s.strokeStyle="rgba(255, 255, 255, 0.3)",s.strokeRect(a,r,99,99))},selectImg:function(t,a){var r;r=this.ctx,r.strokeStyle="rgba(0, 0, 0, 0.8)",r.fillRect(100*t,100*a,98,98)},clearImg:function(t){var a;a=this.ctx,a.save(),a.clearRect(100*t.x-1,100*t.y-1,101,101),a.restore(),this.lastPos=null},getImgPos:function(t){var a,r,e,i;return a=t.offsetX||t.layerX,r=t.offsetY||t.layerY,e=Math.floor(a/100),i=Math.floor(r/100),{x:e,y:i}},bindEvents:function(){var t;t=this,$("#c").off().on("click",function(a){var r,e,i,s,h,n,y,o,p;return a.preventDefault(),t.checkDead(),s=t.getImgPos.apply(t,arguments),o=s&&s.x||0,p=s&&s.y||0,e=t.mapArray,0===e[p][o].type||t.lastPos&&o===t.lastPos.x&&p===t.lastPos.y?void 0:(t.selectImg(o,p),t.lastPos&&e[s.y][s.x].type===e[t.lastPos.y][t.lastPos.x].type&&t.getRoad(t.lastPos,s)?t.isSuccess()&&t.successShow():t.lastPos&&0!==e[t.lastPos.y][t.lastPos.x].type&&(r=t.ctx,h=100*t.lastPos.x,n=100*t.lastPos.y,y=e[t.lastPos.y][t.lastPos.x].type,i=e[t.lastPos.y][t.lastPos.x].nu,r.clearRect(h,n,98,98),r.strokeStyle="rgba(0, 0, 0, 0.8)",r.fillRect(100*o,100*p,98,98),r.drawImage(document.getElementById(t._darray[y-1][i]),h,n,98,98)),t.lastPos={x:o,y:p})})},drawRoad:function(t){var a,r;for(a=this.ctx,a.beginPath(),a.strokeStyle="rgba(0, 0, 0, 0.2)",a.lineWidth=4,a.moveTo(100*t[0].x+50,100*t[0].y+50),r=1;r<t.length;)a.lineTo(100*t[r].x+50,100*t[r].y+50),r++;a.stroke()},clearPath:function(t){var a,r,e,i,s;for(e=this,a=0;a<t.length;)a+1<t.length&&t[a].y===t[a+1].y&&(t[a].x>t[a+1].x?(i=t[a+1].x,r=t[a].x-t[a+1].x+1):t[a].x<t[a+1].x&&(i=t[a].x,r=t[a+1].x-t[a].x+1),this.ctx.clearRect(100*i,100*t[a].y,100*r,100)),a+1<t.length&&t[a].x===t[a+1].x&&(t[a].y>t[a+1].y?(s=t[a+1].y,r=t[a].y-t[a+1].y+1):t[a].y<t[a+1].y&&(s=t[a].y,r=t[a+1].y-t[a].y+1),this.ctx.clearRect(100*t[a].x,100*s,100,100*r)),a++},checkLine:function(t,a){var r,e,i;if(t.x===a.x&&t.y===a.y)return!1;if(t.x===a.x){for(e=a.y>t.y?1:-1,i=t.y+e;i!==a.y;){if(0!==this.mapArray[i][t.x].type)return!1;i+=e}return!0}if(t.y===a.y){for(r=a.x>t.x?1:-1,i=t.x+r;i!==a.x;){if(0!==this.mapArray[t.y][i].type)return!1;i+=r}return!0}return!1},getRoad:function(t,a,r){var e,i,s,h,n,y,o,p,m,c;if(c=this,(t.y===a.y||t.x===a.x)&&this.checkLine(t,a))return r?!0:(m=[t,a],this.mapArray[t.y][t.x].type=0,this.mapArray[a.y][a.x].type=0,this.getConnect(m,[t,a]),!0);for(e=0;2>e;){if(s=null,p=null,0===e?(s=this.mapArray[a.y][t.x].type,p={x:t.x,y:a.y}):(s=this.mapArray[t.y][a.x].type,p={x:a.x,y:t.y}),0===s&&this.checkLine(t,p)&&this.checkLine(p,a))return r?!0:(m=[t,p,a],this.mapArray[t.y][t.x].type=0,this.mapArray[a.y][a.x].type=0,this.getConnect(m,[t,a]),!0);e++}for(e=0;e<this.mapW;)if(e!==t.x&&e!==a.x){if(h=this.mapArray[t.y][e].type,n={x:e,y:t.y},y=this.mapArray[a.y][e].type,o={x:e,y:a.y},0===h&&0===y&&this.checkLine(t,n)&&this.checkLine(n,o)&&this.checkLine(o,a))return r?!0:(m=[t,n,o,a],this.mapArray[t.y][t.x].type=0,this.mapArray[a.y][a.x].type=0,this.getConnect(m,[t,a]),!0);e++}else e++;for(i=0;i<this.mapH;)if(i!==t.y&&i!==a.y){if(h=this.mapArray[i][t.x].type,n={x:t.x,y:i},y=this.mapArray[i][a.x].type,o={x:a.x,y:i},0===h&&0===y&&this.checkLine(t,n)&&this.checkLine(n,o)&&this.checkLine(o,a))return r?!0:(m=[t,n,o,a],this.mapArray[t.y][t.x].type=0,this.mapArray[a.y][a.x].type=0,this.getConnect(m,[t,a]),!0);i++}else i++;return!1},getRandomPot:function(){var t,a;for(t=Math.floor(Math.random()*this.mapW),a=Math.floor(Math.random()*this.mapH);!this.mapArray[a][t].type||0===this.mapArray[a][t].type;)t=Math.floor(Math.random()*this.maoW),a=Math.floor(Math.random()*this.mapH);return{x:t,y:a}},checkDead:function(){var t,a,r,e,i,s,h,n,y,o,p,m;for(e=1;e<this.mapH;){for(s=1;s<this.mapW;)if(this.mapArray[e][s].type&&0!==this.mapArray[e][s].type){for(o={x:s,y:e},n=1;n<this.mapH;){for(y=1;y<this.mapW;)if(this.mapArray[n][y].type&&0!==this.mapArray[n][y].type)if(r={x:y,y:n},o.x!==r.x||o.y!==r.y){if(this.mapArray[e][s].type===this.mapArray[n][y].type&&this.getRoad(o,r,!0))return;y++}else y++;else y++;n++}++s}else s++;++e}for($(".loading").show(),$(".loading i").show(),$(".loading .infos").text("Reordering...please wait."),$(".playground").hide(),this.reordering(),t=document.getElementById("c"),a=t.getContext("2d"),a.clearRect(0,0,t.width,t.height),p=0,m=0,i=0;i<this.mapH;){for(h=0;h<this.mapW;)0===this.mapArray[i][h].type&&0===this.mapArray[i][h].nu||(a=this.ctx,a.fillStyle="rgba(255, 255, 255, 0.3)",a.fillRect(p,m,100,100),a.drawImage(document.getElementById(this._darray[this.mapArray[i][h].nu][this.mapArray[i][h].type]),p,m,98,98),a.lineWidth=1,a.strokeStyle="rgba(255, 255, 255, 0.3)",a.strokeRect(p,m,99,99)),p=p<100*(this.mapW-1)?p+100:0,++h;m=m<100*(this.mapH-1)?m+100:0,++i}$(".loading").hide(),$(".playground").show()},reordering:function(){var t,a;for(t=1;t<this.mapH-1;){for(a=1;a<this.mapW-1;)this.mapArray[t].move(1,this.mapW/2),++a;++t}},isSuccess:function(){var t,a;for(t=1;t<this.mapH;){for(a=1;a<this.mapW;){if(0!==this.mapArray[t][a].type)return!1;++a}++t}return!0},getConnect:function(t,a){var r;r=this,this.drawRoad(t),setTimeout(function(){var e;for(e=0;e<a.length;)r.clearImg(a[e]),e++;return r.clearPath(t)},300)},successShow:function(){$(".playground").hide(),$(".loading").fadeIn("slow"),$(".loading i").hide(),$(".loading .infos").text("Congratulation!!! You win!")}}});